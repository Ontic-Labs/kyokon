{
  "openapi": "3.1.0",
  "info": {
    "title": "Kyokon API",
    "description": "REST API for USDA FoodData Central SR Legacy and Foundation Foods data.\n\n**Kyokon** (Â∑®Ê†π) ‚Äî it means exactly what you think it means. üçÜ\n\nProvides access to **8,158 foods** with nutrients, portions, categories, and cookability data.\n\n---\n\n### Authentication\n\nClick the **Authorize** button above to configure API access.\n\n**API Keys:**\n- Pass via `Authorization: Bearer kyo_...` header or `X-API-Key: kyo_...` header\n- Keys are prefixed with `kyo_` and are 56 characters total\n- Request a key from your administrator via `/admin/keys`\n\n**Development Mode:**\n- Authentication is optional when `NODE_ENV !== 'production'` and `REQUIRE_API_KEY` is not set\n- Legacy single `API_KEY` env var still supported for backward compatibility\n\n**Admin Access:**\n- Admin endpoints require `X-Admin-Secret` header matching server's `ADMIN_SECRET` env var",
    "version": "1.7.0"
  },
  "servers": [
    {
      "url": "/api",
      "description": "Relative API base"
    }
  ],
  "security": [],
  "tags": [
    { "name": "Foods", "description": "Food search and detail endpoints" },
    { "name": "Categories", "description": "Food category endpoints" },
    { "name": "Nutrients", "description": "Nutrient listing endpoints" },
    { "name": "Canonicals", "description": "Canonical ingredient aggregate endpoints" },
    { "name": "Admin", "description": "Administrative endpoints (requires ADMIN_SECRET)" }
  ],
  "paths": {
    "/foods": {
      "get": {
        "summary": "Search and filter foods",
        "description": "Full-text search with optional filters for category, nutrient range, cooking state, preservation, processing, and cookability.",
        "operationId": "searchFoods",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "description": "Full-text search query (uses PostgreSQL plainto_tsquery)",
            "schema": { "type": "string" }
          },
          {
            "name": "categoryId",
            "in": "query",
            "description": "Filter by food category ID",
            "schema": { "type": "integer" }
          },
          {
            "name": "nutrientId",
            "in": "query",
            "description": "Filter by nutrient ID (requires nutrient to exist in food)",
            "schema": { "type": "integer" }
          },
          {
            "name": "min",
            "in": "query",
            "description": "Minimum nutrient amount (requires nutrientId)",
            "schema": { "type": "number" }
          },
          {
            "name": "max",
            "in": "query",
            "description": "Maximum nutrient amount (requires nutrientId)",
            "schema": { "type": "number" }
          },
          {
            "name": "cookable",
            "in": "query",
            "description": "Filter by cookability assessment",
            "schema": { "type": "boolean" }
          },
          {
            "name": "state",
            "in": "query",
            "description": "Cooking state filter",
            "schema": {
              "type": "string",
              "enum": ["unknown", "raw", "cooked"]
            }
          },
          {
            "name": "preservation",
            "in": "query",
            "description": "Preservation method filter",
            "schema": {
              "type": "string",
              "enum": ["unknown", "fresh", "frozen", "canned", "dried", "cured", "pickled", "fermented", "smoked"]
            }
          },
          {
            "name": "processing",
            "in": "query",
            "description": "Physical processing filter",
            "schema": {
              "type": "string",
              "enum": ["unknown", "whole", "ground", "sliced", "diced", "shredded", "pureed", "paste", "powder", "flour", "juice", "oil", "broth", "stock"]
            }
          },
          {
            "name": "canonicalSlug",
            "in": "query",
            "description": "Filter by canonical base slug (e.g. 'beer', 'chicken', 'agave')",
            "schema": { "type": "string" }
          },
          {
            "name": "page",
            "in": "query",
            "description": "Page number (1-indexed)",
            "schema": { "type": "integer", "default": 1, "minimum": 1 }
          },
          {
            "name": "pageSize",
            "in": "query",
            "description": "Items per page",
            "schema": { "type": "integer", "default": 25, "minimum": 1, "maximum": 100 }
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated list of foods",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PaginatedFoods"
                }
              }
            }
          },
          "400": {
            "description": "Invalid query parameters",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/foods/{fdcId}": {
      "get": {
        "summary": "Get food detail",
        "description": "Returns detailed information for a single food, including all nutrients and portion sizes.",
        "operationId": "getFoodDetail",
        "parameters": [
          {
            "name": "fdcId",
            "in": "path",
            "required": true,
            "description": "FDC ID of the food",
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "Food detail with nutrients and portions",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/FoodDetail" }
              }
            }
          },
          "404": {
            "description": "Food not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/categories": {
      "get": {
        "summary": "List food categories",
        "description": "Returns all food categories, optionally with food counts.",
        "operationId": "getCategories",
        "parameters": [
          {
            "name": "includeCounts",
            "in": "query",
            "description": "Include count of foods per category",
            "schema": { "type": "boolean", "default": false }
          }
        ],
        "responses": {
          "200": {
            "description": "List of categories",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    { "$ref": "#/components/schemas/CategoriesResponse" },
                    { "$ref": "#/components/schemas/CategoriesWithCountResponse" }
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/canonicals": {
      "get": {
        "summary": "Search canonical aggregates",
        "description": "Browse and search canonical ingredient aggregates. Each aggregate represents a statistical composite of all foods sharing a canonical name.",
        "operationId": "searchCanonicals",
        "parameters": [
          {
            "name": "q",
            "in": "query",
            "description": "Case-insensitive partial match on canonical name",
            "schema": { "type": "string" }
          },
          {
            "name": "page",
            "in": "query",
            "schema": { "type": "integer", "default": 1, "minimum": 1 }
          },
          {
            "name": "pageSize",
            "in": "query",
            "schema": { "type": "integer", "default": 25, "minimum": 1, "maximum": 100 }
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated list of canonical aggregates",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/PaginatedCanonicals" }
              }
            }
          }
        }
      }
    },
    "/canonicals/{slug}": {
      "get": {
        "summary": "Get canonical aggregate detail",
        "description": "Returns detailed information for a canonical aggregate, including statistical nutrient values (median, p5/p95 boundaries) and source foods.",
        "operationId": "getCanonicalDetail",
        "parameters": [
          {
            "name": "slug",
            "in": "path",
            "required": true,
            "description": "Canonical slug (e.g. 'black-pepper', 'chicken')",
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Canonical aggregate with nutrients and sources",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/CanonicalDetail" }
              }
            }
          },
          "404": {
            "description": "Canonical aggregate not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/nutrients": {
      "get": {
        "summary": "List nutrients",
        "description": "Returns all nutrients with optional search filtering.",
        "operationId": "searchNutrients",
        "parameters": [
          {
            "name": "search",
            "in": "query",
            "description": "Case-insensitive partial match on nutrient name",
            "schema": { "type": "string" }
          },
          {
            "name": "page",
            "in": "query",
            "schema": { "type": "integer", "default": 1, "minimum": 1 }
          },
          {
            "name": "pageSize",
            "in": "query",
            "schema": { "type": "integer", "default": 25, "minimum": 1, "maximum": 100 }
          }
        ],
        "responses": {
          "200": {
            "description": "Paginated list of nutrients",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/PaginatedNutrients" }
              }
            }
          }
        }
      }
    },
    "/admin/keys": {
      "get": {
        "tags": ["Admin"],
        "summary": "List API keys",
        "description": "Returns all API keys with metadata. Does not return the full key, only the prefix.",
        "operationId": "listApiKeys",
        "security": [{ "adminSecret": [] }],
        "responses": {
          "200": {
            "description": "List of API keys",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiKeyList" }
              }
            }
          },
          "401": {
            "description": "Invalid or missing admin secret",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Admin"],
        "summary": "Create API key",
        "description": "Creates a new API key. The full key is only returned once in this response.",
        "operationId": "createApiKey",
        "security": [{ "adminSecret": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["name"],
                "properties": {
                  "name": { "type": "string", "description": "Descriptive name for the key" },
                  "expires_in_days": { "type": "integer", "description": "Days until expiration (optional)" }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "API key created",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiKeyCreated" }
              }
            }
          },
          "400": {
            "description": "Invalid request body",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          },
          "401": {
            "description": "Invalid or missing admin secret",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/admin/keys/{id}": {
      "get": {
        "tags": ["Admin"],
        "summary": "Get API key details",
        "description": "Returns metadata for a single API key.",
        "operationId": "getApiKey",
        "security": [{ "adminSecret": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "API key ID (UUID)",
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "responses": {
          "200": {
            "description": "API key details",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiKeyInfo" }
              }
            }
          },
          "404": {
            "description": "API key not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      },
      "patch": {
        "tags": ["Admin"],
        "summary": "Update API key",
        "description": "Update the name of an API key.",
        "operationId": "updateApiKey",
        "security": [{ "adminSecret": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "API key ID (UUID)",
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": { "type": "string", "description": "New name for the key" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "API key updated",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ApiKeyInfo" }
              }
            }
          },
          "404": {
            "description": "API key not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      },
      "delete": {
        "tags": ["Admin"],
        "summary": "Revoke API key",
        "description": "Revokes an API key. The key will immediately stop working.",
        "operationId": "revokeApiKey",
        "security": [{ "adminSecret": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "API key ID (UUID)",
            "schema": { "type": "string", "format": "uuid" }
          }
        ],
        "responses": {
          "200": {
            "description": "API key revoked",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": { "type": "boolean" },
                    "revoked_at": { "type": "string", "format": "date-time" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "API key not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "apiKey": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key",
        "description": "## API Key Authentication\n\n**Getting a key:**\n- Request from your administrator via the Admin UI at `/admin/keys`\n- Keys are prefixed with `kyo_` (56 characters total)\n\n**Usage:**\n- `Authorization: Bearer kyo_...` header (preferred)\n- `X-API-Key: kyo_...` header\n\n**Development mode:**\n- Leave empty and click Authorize ‚Äî auth is optional in development"
      },
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "description": "Pass API key as Bearer token: `Authorization: Bearer kyo_...`"
      },
      "adminSecret": {
        "type": "apiKey",
        "in": "header",
        "name": "X-Admin-Secret",
        "description": "Admin secret for key management endpoints. Set via `ADMIN_SECRET` env var on the server."
      }
    },
    "schemas": {
      "FoodListItem": {
        "type": "object",
        "required": ["fdcId", "description", "categoryId"],
        "properties": {
          "fdcId": { "type": "integer", "description": "Unique FDC identifier" },
          "description": { "type": "string", "description": "Food name/description" },
          "categoryId": { "type": ["integer", "null"], "description": "Category ID" },
          "categoryName": { "type": "string", "description": "Category name" },
          "canonicalBaseName": { "type": "string", "description": "Canonical base name (broad identity)" },
          "canonicalBaseSlug": { "type": "string", "description": "URL-safe slug of canonical base name" },
          "canonicalSpecificName": { "type": "string", "description": "Canonical specific name (subtype)" },
          "canonicalSpecificSlug": { "type": "string", "description": "URL-safe slug of canonical specific name" },
          "cookingState": { "type": "string", "enum": ["unknown", "raw", "cooked"] },
          "cookingMethods": { "type": "array", "items": { "type": "string" } },
          "preservation": { "type": "string" },
          "processing": { "type": "string" }
        }
      },
      "FoodDetail": {
        "type": "object",
        "required": ["fdcId", "description", "dataType", "publishedDate", "category", "nutrients", "portions"],
        "properties": {
          "fdcId": { "type": "integer" },
          "description": { "type": "string" },
          "dataType": { "type": "string" },
          "publishedDate": { "type": ["string", "null"], "format": "date" },
          "category": {
            "oneOf": [
              { "$ref": "#/components/schemas/CategoryInfo" },
              { "type": "null" }
            ]
          },
          "canonicalBaseName": { "type": "string", "description": "Canonical base name (broad identity)" },
          "canonicalBaseSlug": { "type": "string", "description": "URL-safe slug of canonical base name" },
          "canonicalSpecificName": { "type": "string", "description": "Canonical specific name (subtype)" },
          "canonicalSpecificSlug": { "type": "string", "description": "URL-safe slug of canonical specific name" },
          "nutrients": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/NutrientInfo" }
          },
          "portions": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/PortionInfo" }
          }
        }
      },
      "NutrientInfo": {
        "type": "object",
        "required": ["nutrientId", "name", "unit", "amount"],
        "properties": {
          "nutrientId": { "type": "integer" },
          "name": { "type": "string" },
          "unit": { "type": "string" },
          "amount": { "type": "number" }
        }
      },
      "NutrientListItem": {
        "type": "object",
        "required": ["nutrientId", "name", "unit", "rank", "isEnergy"],
        "properties": {
          "nutrientId": { "type": "integer" },
          "name": { "type": "string" },
          "unit": { "type": "string" },
          "rank": { "type": ["integer", "null"] },
          "isEnergy": { "type": "boolean" }
        }
      },
      "PortionInfo": {
        "type": "object",
        "required": ["gramWeight", "amount", "unit", "modifier"],
        "properties": {
          "gramWeight": { "type": "number" },
          "amount": { "type": ["number", "null"] },
          "unit": { "type": ["string", "null"] },
          "modifier": { "type": ["string", "null"] }
        }
      },
      "CategoryInfo": {
        "type": "object",
        "required": ["categoryId", "name"],
        "properties": {
          "categoryId": { "type": "integer" },
          "name": { "type": "string" }
        }
      },
      "CategoryWithCount": {
        "type": "object",
        "required": ["categoryId", "name", "foodCount"],
        "properties": {
          "categoryId": { "type": "integer" },
          "name": { "type": "string" },
          "foodCount": { "type": "integer" }
        }
      },
      "PaginatedFoods": {
        "type": "object",
        "required": ["items", "total", "page", "pageSize"],
        "properties": {
          "items": { "type": "array", "items": { "$ref": "#/components/schemas/FoodListItem" } },
          "total": { "type": "integer" },
          "page": { "type": "integer" },
          "pageSize": { "type": "integer" }
        }
      },
      "PaginatedNutrients": {
        "type": "object",
        "required": ["items", "total", "page", "pageSize"],
        "properties": {
          "items": { "type": "array", "items": { "$ref": "#/components/schemas/NutrientListItem" } },
          "total": { "type": "integer" },
          "page": { "type": "integer" },
          "pageSize": { "type": "integer" }
        }
      },
      "CategoriesResponse": {
        "type": "object",
        "required": ["categories"],
        "properties": {
          "categories": { "type": "array", "items": { "$ref": "#/components/schemas/CategoryInfo" } }
        }
      },
      "CategoriesWithCountResponse": {
        "type": "object",
        "required": ["categories"],
        "properties": {
          "categories": { "type": "array", "items": { "$ref": "#/components/schemas/CategoryWithCount" } }
        }
      },
      "CanonicalListItem": {
        "type": "object",
        "required": ["canonicalId", "canonicalSlug", "canonicalName", "foodCount"],
        "properties": {
          "canonicalId": { "type": "integer", "description": "Synthetic FDC ID (9,200,000+)" },
          "canonicalSlug": { "type": "string", "description": "URL-safe slug" },
          "canonicalName": { "type": "string", "description": "Human-readable canonical name" },
          "foodCount": { "type": "integer", "description": "Number of source foods in this aggregate" }
        }
      },
      "CanonicalNutrient": {
        "type": "object",
        "required": ["nutrientId", "name", "unit", "median", "p5", "p95", "min", "max", "sampleCount"],
        "properties": {
          "nutrientId": { "type": "integer" },
          "name": { "type": "string" },
          "unit": { "type": "string" },
          "median": { "type": "number", "description": "Median value per 100g across source foods" },
          "p5": { "type": ["number", "null"], "description": "5th percentile (null if n < 3)" },
          "p95": { "type": ["number", "null"], "description": "95th percentile (null if n < 3)" },
          "min": { "type": "number" },
          "max": { "type": "number" },
          "sampleCount": { "type": "integer", "description": "Number of foods with this nutrient" }
        }
      },
      "CanonicalSource": {
        "type": "object",
        "required": ["fdcId", "description", "dataType"],
        "properties": {
          "fdcId": { "type": "integer" },
          "description": { "type": "string" },
          "dataType": { "type": "string" }
        }
      },
      "CanonicalDetail": {
        "type": "object",
        "required": ["canonicalId", "canonicalSlug", "canonicalName", "level", "foodCount", "dataTypes", "representativeFdcId", "nutrients", "sources"],
        "properties": {
          "canonicalId": { "type": "integer" },
          "canonicalSlug": { "type": "string" },
          "canonicalName": { "type": "string" },
          "level": { "type": "string" },
          "foodCount": { "type": "integer" },
          "dataTypes": { "type": "array", "items": { "type": "string" } },
          "representativeFdcId": { "type": ["integer", "null"] },
          "nutrients": { "type": "array", "items": { "$ref": "#/components/schemas/CanonicalNutrient" } },
          "sources": { "type": "array", "items": { "$ref": "#/components/schemas/CanonicalSource" } }
        }
      },
      "PaginatedCanonicals": {
        "type": "object",
        "required": ["items", "total", "page", "pageSize"],
        "properties": {
          "items": { "type": "array", "items": { "$ref": "#/components/schemas/CanonicalListItem" } },
          "total": { "type": "integer" },
          "page": { "type": "integer" },
          "pageSize": { "type": "integer" }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "required": ["error"],
        "properties": {
          "error": {
            "type": "object",
            "required": ["code", "message"],
            "properties": {
              "code": { "type": "string", "enum": ["BAD_REQUEST", "UNAUTHORIZED", "NOT_FOUND", "INTERNAL_ERROR"] },
              "message": { "type": "string" },
              "details": { "type": "object" }
            }
          }
        }
      },
      "ApiKeyInfo": {
        "type": "object",
        "required": ["id", "name", "key_prefix", "created_at", "request_count"],
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "name": { "type": "string", "description": "Descriptive name for the key" },
          "key_prefix": { "type": "string", "description": "First 8 characters of the key (kyo_xxxx)" },
          "created_at": { "type": "string", "format": "date-time" },
          "expires_at": { "type": ["string", "null"], "format": "date-time" },
          "revoked_at": { "type": ["string", "null"], "format": "date-time" },
          "last_used_at": { "type": ["string", "null"], "format": "date-time" },
          "request_count": { "type": "integer", "description": "Total number of requests made with this key" }
        }
      },
      "ApiKeyList": {
        "type": "object",
        "required": ["keys"],
        "properties": {
          "keys": { "type": "array", "items": { "$ref": "#/components/schemas/ApiKeyInfo" } }
        }
      },
      "ApiKeyCreated": {
        "type": "object",
        "required": ["id", "key", "name"],
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "key": { "type": "string", "description": "Full API key (only shown once!)" },
          "name": { "type": "string" },
          "expires_at": { "type": ["string", "null"], "format": "date-time" }
        }
      }
    }
  }
}
